<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>MXN to USD and XCD Converter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font: 16px system-ui, sans-serif; max-width: 640px; margin: 2rem auto; }
    label, input, button { font: inherit; }
    .row { margin: 1rem 0; }
    .out { padding: .5rem 0; }
    .muted { color: #555; font-size: .9rem; }
    .error { color: #b00020; }
    .card { border: 1px solid #ddd; padding: 1rem; border-radius: .5rem; }
  </style>
</head>
<body>
  <h1>MXN → USD and XCD</h1>

  <div class="row">
    <label for="mxn">Amount in MXN</label><br>
    <input id="mxn" type="number" step="0.01" min="0" placeholder="0.00">
    <button id="convert">Convert</button>
    <button id="share">Copy shareable link</button>
  </div>

  <div id="status" class="muted"></div>

  <div id="results" class="card" hidden>
    <div class="out"><strong>USD:</strong> <span id="usd">–</span></div>
    <div class="out"><strong>XCD:</strong> <span id="xcd">–</span></div>
    <div class="muted" id="asof"></div>
  </div>

  <div id="error" class="error" hidden></div>

  <script>
    const state = {
      api: "https://api.frankfurter.dev/latest",
      pegXCDperUSD: 2.70
    };

    const $ = id => document.getElementById(id);

    function setQuery(amount) {
      const u = new URL(location.href);
      if (amount === "" || isNaN(Number(amount))) {
        u.searchParams.delete("mxn");
      } else {
        u.searchParams.set("mxn", String(amount));
      }
      history.replaceState(null, "", u.toString());
    }

    async function convert() {
      const mxnStr = $("mxn").value.trim();
      $("error").hidden = true;
      $("results").hidden = true;
      $("status").textContent = "Loading live rate…";

      const mxn = Number(mxnStr);
      if (!isFinite(mxn) || mxn < 0) {
        $("status").textContent = "";
        $("error").hidden = false;
        $("error").textContent = "Enter a valid non-negative number.";
        return;
      }

      try {
        const url = `${state.api}?from=MXN&to=USD`;
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const rate = data.rates?.USD;
        const date = data.date;
        if (!rate) throw new Error("Rate not found");

        const usd = mxn * rate;
        const xcd = usd * state.pegXCDperUSD;

        $("usd").textContent = usd.toFixed(2);
        $("xcd").textContent = xcd.toFixed(2);
        $("asof").textContent = `As of ${date}`;
        $("results").hidden = false;
        $("status").textContent = "";
        setQuery(mxnStr);
      } catch (e) {
        $("status").textContent = "";
        $("error").hidden = false;
        $("error").textContent = "Could not fetch rates. Try again.";
        console.error(e);
      }
    }

    function initFromURL() {
      const params = new URLSearchParams(location.search);
      const q = params.get("mxn");
      if (q) $("mxn").value = q;
      if (q) convert();
    }

    $("convert").addEventListener("click", convert);
    $("share").addEventListener("click", async () => {
      setQuery($("mxn").value.trim());
      try {
        await navigator.clipboard.writeText(location.href);
        $("status").textContent = "Link copied to clipboard.";
        setTimeout(() => $("status").textContent = "", 2000);
      } catch {
        $("status").textContent = "Copy failed. Manually copy the URL.";
      }
    });

    initFromURL();
  </script>
</body>
</html>
